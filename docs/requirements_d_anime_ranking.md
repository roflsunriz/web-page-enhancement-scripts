# 要件定義書：dアニメストア CFページ 人気度（ニコニコ指標）オーバーレイ表示ユーザースクリプト

## 1. 概要

dアニメストアのクール別ページ（`/animestore/CF/*`）上の作品カードに、ニコニコ動画由来の人気指標（再生数/マイリスト数/コメント数/いいね数）を用いた総合順位をオーバーレイ表示する。表示は「第*位」。詳細はホバーで内訳を提示する。

## 2. 目的

* CFページ閲覧時に「作品の人気度」を直感的に比較できるようにする
* ページ表示の体感を崩さず、スクロールに応じて遅延取得する
* 取得失敗時に原因を隠さず、ユーザー操作でリトライ可能にする

## 3. 対象範囲

### 対象ページ

* `https://animestore.docomo.ne.jp/animestore/CF/*`（ワイルドカード）

### 前提条件

* dアニメストアにログイン済みでの利用を前提（未ログインは非対応）

### 対象UI（挿入位置）

* 作品カードのサムネイル右側領域
* 「円形グラフ」要素と「ハート」要素の間の空間に挿入する
* 「ブック」要素は存在しないカードがあるため依存しない

## 4. 技術スタック / 実行環境

### 実行環境

* ユーザースクリプト: Tampermonkey
* ブラウザ: Firefox / Chrome
* モバイル: 非対応

### 開発スタック

* TypeScript, Vite, vite-plugin-monkey, React, TailwindCSS
* Zod（設定/永続化スキーマ）
* IndexedDB（キャッシュ）
* Playwright（E2E）
* Vitest（ユニット）

## 5. 人気度データ仕様（ニコニコ由来）

### 取得対象指標

* 再生数
* マイリスト数
* コメント数
* いいね数

### 対象期間

* 全期間（累計）

### 作品の紐づけキー

* dアニメストア側の「作品タイトルテキスト」をキーとして扱う

### マッチング方針（完全一致のみ）

* 検索はタイトルのみを入力値とし、以下いずれかの「完全一致」条件で候補採用

  1. `作品タイトル`
  2. `作品タイトル 第n期`（正規化後）
  3. 投稿者名ガードによる採用（後述）

### 投稿者名ガード（重要）

投稿者は2種を区別する。

* 「dアニメストア ニコニコ支店」投稿者
  dアニメストア運営アカウント（dアニメ側の投稿）
* 「作品タイトル」投稿者
  ニコニコ動画側の公式アカウント（作品公式の投稿）

マッチングにおいて投稿者名ガードを使う場合は、上記を明示的に区別して扱う。

## 6. 代表動画の決定ルール（作品＝代表動画の指標とする）

### 第一話の定義（採用ルール）

* 原則：対象（投稿者ガード適用後）の動画群から「最古の投稿日」の動画を第一話扱いとして代表にする
* これにより `第1話/#1/Episode 1` 等の表記ゆれに依存しない

### 代表動画が見つからない場合

* 「dアニメストア ニコニコ支店投稿者」の候補が見つかる場合：その中で最古動画を代表として採用
* それでも見つからない場合：取得失敗扱い（UIに失敗表示+リトライ）

## 7. スコア計算と順位化

### 対象範囲（母集団）

* 正規化・順位付けの母集団は「ページ内の作品一覧の全件（C）」を前提にする
  ただし指標取得は遅延でよいが、ランキングの一貫性のため「作品一覧の収集（タイトル群の確定）」は先に行う。

### スコア計算（推奨案1）

各作品について以下を計算。

* 変換：指標ごとに `log10(value + 1)`
* 正規化：ページ内全作品を母集団として、指標ごとに min-max 正規化
* 合成：4指標を等重み平均し「総合スコア」とする
* 順位：総合スコア降順で順位付け

補足（設計上の注意）

* min-max の `max == min` の場合はその指標は全作品同値として正規化値を一定（例：0）に固定する
* 欠損（取得失敗）作品は総合スコア欠損扱い（順位なし）

### 表示仕様

* 作品カード：`第{rank}位` を表示
* 順位未確定（未取得/計算待ち）：ローディング表示またはプレースホルダ（例：`…`）

## 8. ランク（色付け）

### ランク帯（パーセンタイル）

* S：上位10%
* A：10–25%
* B：25–50%
* C：50–75%
* D：75–100%

表示例

* `第12位` + バッジ色（S/A/B/C/D）

## 9. UI/UX 詳細

### オーバーレイ位置

* 円形グラフ要素とハート要素の間のスペースに、インライン要素として配置
* DOMが崩れた場合でも「2要素の存在」を基準に再探索して挿入する

### ホバー詳細（ツールチップ）

ホバーで次を表示。

* 総合スコア（任意。小数は丸め）
* 4指標の生値（再生/マイリスト/コメント/いいね）
* 指標ごとの正規化値（0–1）
* 総合スコア合成の内訳（4指標が等重みであることの明示）
* 代表動画の識別情報（最低限：投稿日、投稿者種別、タイトル）
* データ取得日時（キャッシュ判定の説明用）

### 設定

* 設定項目は1つのみ：表示 ON/OFF
* 設定UIの形は実装都合でよい（例：Tampermonkey menu、簡易トグル、URLパラメータ等）
* スキーマは Zod で定義し、永続化する

## 10. 取得・更新・キャッシュ

### 更新頻度

* TTL：24時間（1日1回更新）
* TTL内はキャッシュを優先し、ネットワーク再取得を行わない

### 永続化

* IndexedDB に保存
* 保存単位は最低でも以下を持つ

  * title（作品タイトル。検索キー）
  * canonicalQuery（検索に用いた正規化後タイトル。例：`第n期` 反映）
  * representativeVideoId（取得できるなら）
  * metrics（4指標）
  * fetchedAt（取得時刻）
  * status（ok / failed / pending）
  * failureReason（失敗時の理由文字列）

### 取得制御

* 作品一覧（全タイトル）を先に収集し、ランキング母集団を確定
* 指標取得は「ビューポートに入った作品」から最大10件まで
* 並列数：5
* スクロールに応じて随時取得し、取得できた範囲で表示を更新

## 11. エラーハンドリング

### 失敗時の表示

* 作品カードに以下のいずれか、または両方を表示

  * `取得に失敗しました`
  * 警告アイコン（MDI 等）
* 失敗の理由はホバー詳細で見えるようにする（可能なら）

### リトライ

* 失敗状態のカードに「リトライ」ボタンを表示
* クリックで当該作品のみ再取得（TTL無視で強制）
* リトライ連打対策（最低限）

  * 連続実行の抑制（例：直近数秒のクールダウン）

## 12. タイトル正規化（第n期への寄せ）

### 正規化対象

* `2nd season / Season 2 / 第2期 / 2期` を `第2期` へ統一
* ローマ数字も寄せる（例：`II` → `2` → `第2期`）
* `続編 / 完結編 / 後編` は期扱いしない（正規化しない）

補足

* 正規化は「検索クエリ生成」にのみ影響し、dアニメ上の表示タイトル自体は変更しない

## 13. 非機能要件

### パフォーマンス

* DOM監視は最小限（必要なら `MutationObserver` でカード追加を追跡）
* 取得はビューポート10件・並列5を厳守
* UIは取得結果が揃うまでブロックしない（逐次描画）

### 耐久性（DOM変化）

* 依存要素は「円形グラフ」「ハート」の存在のみ
* セレクタが変わり得る前提で、再探索・再挿入ができる設計にする
* 開発段階で、ページ構造スニペットをドキュメントに添付する（ユーザー提供予定）

### プライバシー

* 外部送信は作品タイトルのみ
* APIキー運用なし

## 14. テスト計画（最小セットで実装事故を防ぐ）

### Vitest（ユニット）

* タイトル正規化（season/ローマ数字/期扱いしない語）
* 代表動画の決定（投稿者フィルタ→最古投稿日選択）
* スコア計算（log→minmax→平均→順位）
* TTL判定（24h）と状態遷移（ok/failed/pending）

### Playwright（E2E/スモーク）

* CFページを開き、作品カードを検出できる
* ネットワーク層をモックして、順位表示が出る
* ホバーで詳細が表示される
* 失敗状態をモックし、リトライ押下で再取得フローが走る
* スクロールで対象が変わり、ビューポート10件制限が守られる

## 15. 既知のリスクと対策

* 完全一致のため、タイトル表記ゆれでヒットしない可能性がある

  * 対策：第n期正規化、投稿者ガード、失敗+リトライで可視化
* 代表動画を最古投稿日で取るため、シリーズ構造が異なる場合に第一話とズレる可能性がある

  * 対策：ホバー詳細に代表根拠（投稿日/投稿者/タイトル）を明示
* DOMの差異（カード種類の違い）

  * 対策：円形グラフ・ハートの相対配置に限定し、再探索で追従
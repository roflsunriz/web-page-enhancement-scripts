// ==UserScript==
// @name         x-auto-spam-reporter
// @namespace    xAutoSpamReporter
// @version      1.0.0
// @author       roflsunriz
// @description  X/Twitterã®ãƒ„ã‚¤ãƒ¼ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã§ãƒªãƒ—ãƒ©ã‚¤ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ‘ãƒ å ±å‘Šï¼†ãƒ–ãƒ­ãƒƒã‚¯
// @license      MIT
// @icon         https://www.google.com/s2/favicons?sz=64&domain=x.com
// @downloadURL  https://raw.githubusercontent.com/roflsunriz/web-page-enhancement-scripts/refs/heads/main/dist/x-auto-spam-reporter.user.js
// @updateURL    https://raw.githubusercontent.com/roflsunriz/web-page-enhancement-scripts/refs/heads/main/dist/x-auto-spam-reporter.meta.js
// @match        https://twitter.com/*/status/*
// @match        https://x.com/*/status/*
// @grant        GM_registerMenuCommand
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    const f={debug:"debug",info:"info",warn:"warn",error:"error"},g=n=>{const t=`[${n}]`,s={};return Object.keys(f).forEach(e=>{const o=f[e];s[e]=(...r)=>{(console[o]??console.log)(t,...r);};}),s},i={tweet:'article[data-testid="tweet"]',moreButton:'[data-testid="caret"]',reportMenuItem:'[data-testid="report"]',blockMenuItem:'[data-testid="block"]',menu:'[role="menu"]',menuItem:'[role="menuitem"]',dialog:'[role="dialog"]',nextButton:'[data-testid="ocfSettingsListNextButton"]',layersContainer:"#layers",primaryColumn:'[data-testid="primaryColumn"]',userName:'[data-testid="User-Name"]'},w={ja:["ã‚¹ãƒ‘ãƒ "],en:["spam","Spam"]},b={ja:["ã•ã‚“ã‚’ãƒ–ãƒ­ãƒƒã‚¯"],en:["Block @"]},y={ja:["æ¬¡ã¸"],en:["Next"]},p={ja:["å®Œäº†"],en:["Done"]};var T="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z",v="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z",C="M13 13H11V7H13M11 15H13V17H11M15.73 3H8.27L3 8.27V15.73L8.27 21H15.73L21 15.73V8.27L15.73 3Z",L="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z",k="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z",B="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z",M="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z",E="M6,2V8H6V8L10,12L6,16V16H6V22H18V16H18V16L14,12L18,8V8H18V2H6M16,16.5V20H8V16.5L12,12.5L16,16.5M12,11.5L8,7.5V4H16V7.5L12,11.5Z";function u(n,t=24){const s=String(t),e=String(t);return `<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${e}" viewBox="0 0 24 24" fill="currentColor" role="img" aria-hidden="true" focusable="false"><path d="${n}"></path></svg>`}const A=u(E),O=u(C),H=u(L),V=u(k),I=u(v),N=u(T),$=u(B),D=u(M),S=g("x-auto-spam-reporter:ui"),h={default:{position:"absolute",right:"8px",top:"8px",zIndex:"9999",padding:"6px",fontSize:"14px",background:"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"bold",boxShadow:"0 2px 8px rgba(239, 68, 68, 0.4)",transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px"},hover:{transform:"scale(1.05)",boxShadow:"0 4px 12px rgba(239, 68, 68, 0.6)"},processing:{background:"linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",cursor:"wait"},done:{background:"linear-gradient(135deg, #10b981 0%, #059669 100%)"}},j={position:"fixed",bottom:"20px",right:"20px",padding:"16px 24px",background:"rgba(0, 0, 0, 0.9)",color:"white",borderRadius:"12px",fontSize:"14px",zIndex:"99999",maxWidth:"400px",boxShadow:"0 8px 32px rgba(0,0,0,0.4)",backdropFilter:"blur(8px)",transition:"all 0.3s ease",display:"flex",alignItems:"center",gap:"12px"},R={success:"#10b981",error:"#ef4444",warning:"#f59e0b",processing:"#3b82f6",info:"#6b7280"},q={info:$,success:V,error:I,warning:N,processing:D},m={default:O,processing:A,done:H};class F{toastElement=null;addedButtons=new WeakSet;addButtonToTweet(t,s){if(this.addedButtons.has(t))return;const e=document.createElement("button");e.innerHTML=m.default,e.title="ã‚¹ãƒ‘ãƒ ã¨ã—ã¦å ±å‘Šï¼†ãƒ–ãƒ­ãƒƒã‚¯",e.className="x-auto-spam-reporter-btn",Object.assign(e.style,h.default),e.addEventListener("mouseenter",()=>{e.dataset.processing!=="true"&&Object.assign(e.style,h.hover);}),e.addEventListener("mouseleave",()=>{e.dataset.processing!=="true"&&(e.style.transform="",e.style.boxShadow=h.default.boxShadow);}),window.getComputedStyle(t).position==="static"&&(t.style.position="relative"),e.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),await s(t,e);}),t.appendChild(e),this.addedButtons.add(t),S.debug("ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ");}setButtonProcessing(t){t.dataset.processing="true",Object.assign(t.style,h.processing),t.innerHTML=m.processing;}setButtonDone(t){t.dataset.processing="false",Object.assign(t.style,h.done),t.innerHTML=m.done,t.disabled=true;}resetButton(t){t.dataset.processing="false",Object.assign(t.style,h.default),t.innerHTML=m.default;}showToast(t,s=3e3,e="info"){this.toastElement&&this.toastElement.remove();const o=document.createElement("div");o.className="x-auto-spam-reporter-toast";const r=q[e];o.innerHTML=`
      <span style="display: flex; align-items: center;">${r}</span>
      <span style="white-space: pre-line;">${this.escapeHtml(t)}</span>
    `,Object.assign(o.style,j);const a=R[e];a&&(o.style.borderLeft=`4px solid ${a}`),document.body.appendChild(o),this.toastElement=o,s>0&&setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(100%)",setTimeout(()=>o.remove(),300);},s);}escapeHtml(t){const s=document.createElement("div");return s.textContent=t,s.innerHTML}destroy(){document.querySelectorAll(".x-auto-spam-reporter-btn").forEach(t=>t.remove()),document.querySelectorAll(".x-auto-spam-reporter-toast").forEach(t=>t.remove()),this.toastElement=null,S.debug("UIã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ");}}const l=g("x-auto-spam-reporter:reporter"),P={debug:true,autoBlock:true,delays:{menuOpen:300,menuClick:200,dialogLoad:500,stepInterval:400,animation:300}};class _{config;stats={reported:0,blocked:0,errors:0};isProcessing=false;constructor(t={}){this.config={...P,...t};}get processing(){return this.isProcessing}getStats(){return {...this.stats}}setAutoBlock(t){this.config.autoBlock=t,l.info(`è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯: ${t?"ON":"OFF"}`);}sleep(t){return new Promise(s=>setTimeout(s,t))}async waitForElement(t,s=5e3){const e=Date.now();for(;Date.now()-e<s;){const o=document.querySelector(t);if(o)return o;await this.sleep(100);}return null}getScrollableContainer(){const t=document.querySelector(i.dialog);if(!t)return null;const s=Array.from(t.querySelectorAll("div"));for(const e of s){const r=window.getComputedStyle(e).overflowY;if((r==="auto"||r==="scroll")&&e.scrollHeight>e.clientHeight)return e}return t}async findElementWithScroll(t,s,e=10){const o=t??this.getScrollableContainer()??document.body;let r=s();if(r)return r.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),r;const a=200;for(let d=0;d<e;d++){if(o.scrollTop+=a,await this.sleep(150),r=s(),r)return r.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),r;if(o.scrollTop+o.clientHeight>=o.scrollHeight)break}return o.scrollTop=0,await this.sleep(200),r=s(),r?(r.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),r):null}findByText(t,s='label, button, [role="button"], [role="option"], [role="radio"]'){const e=Array.from(document.querySelectorAll(s));for(const o of e){const r=o.textContent??"";for(const a of t)if(r.includes(a))return o}return null}async selectSpamOption(){if(!await this.waitForElement(i.dialog,3e3))throw new Error("å ±å‘Šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");await this.sleep(this.config.delays.dialogLoad);const s=this.getScrollableContainer(),e=[...w.ja,...w.en],o=await this.findElementWithScroll(s,()=>this.findByText(e));if(!o)throw new Error("ã€Œã‚¹ãƒ‘ãƒ ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");l.debug("ã‚¹ãƒ‘ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"),o.click(),await this.sleep(this.config.delays.menuClick);}async clickNextButton(){const t=this.getScrollableContainer(),s=[...y.ja,...y.en],e=await this.findElementWithScroll(t,()=>{const o=document.querySelector(i.nextButton);if(o){const r=o.textContent?.trim()??"";if(![...p.ja,...p.en].some(d=>r===d))return o}return this.findByText(s,'button, [role="button"]')});e?(l.debug("ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"),e.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),e.click(),await this.sleep(this.config.delays.animation)):l.debug("ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰");}async clickBlockButton(){const t=this.getScrollableContainer(),s=[...b.ja,...b.en],e=await this.findElementWithScroll(t,()=>this.findByText(s,'button, [role="button"]'));if(!e){l.debug("ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰");return}l.debug("ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"),e.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),e.click(),await this.sleep(this.config.delays.animation);}async clickDoneButton(){const t=this.getScrollableContainer(),s=[...p.ja,...p.en],e=await this.findElementWithScroll(t,()=>{const o=document.querySelector(i.nextButton);return o||this.findByText(s,'button, [role="button"]')});e&&(l.debug("å®Œäº†ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"),e.scrollIntoView({behavior:"smooth",block:"center"}),await this.sleep(200),e.click(),await this.sleep(this.config.delays.animation));}async tryCloseDialog(){document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",bubbles:true})),await this.sleep(200);const t=Array.from(document.querySelectorAll('[aria-label="é–‰ã˜ã‚‹"], [aria-label="Close"]'));for(const s of t)s.click(),await this.sleep(200);}async report(t){if(this.isProcessing)throw new Error("æ—¢ã«å‡¦ç†ä¸­ã§ã™");this.isProcessing=true;const e=t.querySelector(i.userName)?.textContent?.match(/@[\w]+/)?.[0]??"ä¸æ˜";try{l.info(`å ±å‘Šé–‹å§‹: ${e}`);const o=t.querySelector(i.moreButton);if(!o)throw new Error("3ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");o.click(),await this.sleep(this.config.delays.menuOpen);const r=await this.waitForElement(i.reportMenuItem,3e3);if(!r)throw new Error("ã€Œãƒã‚¹ãƒˆã‚’å ±å‘Šã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return r.click(),await this.sleep(this.config.delays.dialogLoad),await this.selectSpamOption(),await this.sleep(this.config.delays.stepInterval),await this.clickNextButton(),await this.sleep(this.config.delays.dialogLoad),this.config.autoBlock&&(await this.clickBlockButton(),await this.sleep(this.config.delays.stepInterval),this.stats.blocked++),await this.clickDoneButton(),this.stats.reported++,l.info(`å ±å‘Šå®Œäº†: ${e}`),{success:!0,userName:e}}catch(o){throw this.stats.errors++,l.error("å ±å‘Šã‚¨ãƒ©ãƒ¼:",o),await this.tryCloseDialog(),o}finally{this.isProcessing=false;}}}const c=g("x-auto-spam-reporter");class K{ui;reporter;observer=null;isInitialized=false;constructor(){this.ui=new F,this.reporter=new _;}initialize(){if(this.isInitialized){c.warn("æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™");return}c.info("åˆæœŸåŒ–ä¸­..."),this.setupObserver(),this.processExistingTweets(),this.registerMenuCommand(),this.isInitialized=true,this.ui.showToast(`ğŸš¨ ã‚¹ãƒ‘ãƒ è‡ªå‹•å ±å‘Šãƒ¢ãƒ¼ãƒ‰
ãƒªãƒ—ãƒ©ã‚¤ã®ã€ŒğŸš¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯`,4e3,"info"),c.info("åˆæœŸåŒ–å®Œäº†");}setupObserver(){this.observer=new MutationObserver(s=>{for(const e of s)for(const o of Array.from(e.addedNodes))o instanceof HTMLElement&&(o.matches(i.tweet)&&this.addButtonToTweet(o),o.querySelectorAll(i.tweet).forEach(r=>{this.addButtonToTweet(r);}));});const t=document.querySelector(i.primaryColumn);t?this.observer.observe(t,{childList:true,subtree:true}):this.observer.observe(document.body,{childList:true,subtree:true});}processExistingTweets(){document.querySelectorAll(i.tweet).forEach(t=>{this.addButtonToTweet(t);});}isMainTweet(t){const s=document.querySelectorAll(i.tweet);return s.length>0&&s[0]===t}addButtonToTweet(t){this.isMainTweet(t)||this.ui.addButtonToTweet(t,async(s,e)=>{if(this.reporter.processing){this.ui.showToast("â³ å‡¦ç†ä¸­ã§ã™...",2e3,"warning");return}this.ui.setButtonProcessing(e);try{const r=s.querySelector(i.userName)?.textContent?.match(/@[\w]+/)?.[0]??"ä¸æ˜";this.ui.showToast(`ğŸ”„ ${r} ã‚’å ±å‘Šä¸­...`,0,"processing");const a=await this.reporter.report(s);if(a.success){this.ui.setButtonDone(e);const d=this.reporter.getStats(),x=`âœ… ${a.userName} ã‚’ã‚¹ãƒ‘ãƒ å ±å‘Šï¼†ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ
(å ±å‘Š: ${d.reported}, ãƒ–ãƒ­ãƒƒã‚¯: ${d.blocked})`;this.ui.showToast(x,3e3,"success");}}catch(o){this.ui.resetButton(e);const r=o instanceof Error?o.message:"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";this.ui.showToast(`âŒ ã‚¨ãƒ©ãƒ¼: ${r}`,4e3,"error");}});}registerMenuCommand(){typeof GM_registerMenuCommand<"u"&&(GM_registerMenuCommand("çµ±è¨ˆã‚’è¡¨ç¤º",()=>{const t=this.reporter.getStats();this.ui.showToast(`ğŸ“Š çµ±è¨ˆ
å ±å‘Š: ${t.reported}
ãƒ–ãƒ­ãƒƒã‚¯: ${t.blocked}
ã‚¨ãƒ©ãƒ¼: ${t.errors}`,5e3,"info");}),GM_registerMenuCommand("è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯ã‚’OFF",()=>{this.reporter.setAutoBlock(false),this.ui.showToast("è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯: OFF",2e3,"info");}),GM_registerMenuCommand("è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯ã‚’ON",()=>{this.reporter.setAutoBlock(true),this.ui.showToast("è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯: ON",2e3,"info");}));}getStats(){return this.reporter.getStats()}setAutoBlock(t){this.reporter.setAutoBlock(t),this.ui.showToast(`è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯: ${t?"ON":"OFF"}`,2e3,"info");}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.ui.destroy(),this.isInitialized=false,c.info("ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");}}function W(n=1e4){return new Promise((t,s)=>{const e=Date.now(),o=()=>{if(document.getElementById("react-root")){t();return}if(Date.now()-e>n){s(new Error("Timeout waiting for react-root"));return}setTimeout(o,100);};o();})}(async()=>{try{c.info("èµ·å‹•ä¸­..."),await W(),c.info("React root found");const n=new K;n.initialize(),window.xAutoSpamReporter=n,c.info("èµ·å‹•å®Œäº†");}catch(n){c.error("èµ·å‹•ã‚¨ãƒ©ãƒ¼:",n);}})();

})();
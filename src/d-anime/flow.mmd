flowchart TD
    %% 起動とページ分岐
    Start[スクリプト開始] --> Initialize[initialize関数実行]
    Initialize --> CheckPath{URL確認}

    CheckPath -->|動画視聴ページ| WaitForVideo[video要素を待機]
    CheckPath -->|マイページ| CreateSettingsUI[設定UI作成]

    %% 視聴ページ: 初期化とコメント描画
    WaitForVideo --> InitWithVideo[initializeWithVideo実行]
    InitWithVideo --> InitSettingsManager[SettingsManagerを初期化]
    InitSettingsManager --> CheckVideoData{動画データあり?}
    CheckVideoData -->|はい| InitApiFetcher[NicoApiFetcherを初期化]
    CheckVideoData -->|いいえ| ErrorNoData[エラー: 動画データなし]
    InitApiFetcher --> FetchApiData[APIデータを取得]
    FetchApiData --> FetchComments[コメントを取得]
    FetchComments --> InitRenderer[CommentRendererを初期化]
    InitRenderer --> AddComments[コメントを追加]
    AddComments --> InitSwitchHandler[VideoSwitchHandlerを初期化]
    InitSwitchHandler --> SetupObservers[監視設定と各種イベント設定]
    SetupObservers --> CompleteInit[初期化完了]

    %% マイページ: 設定UI + 検索フロー
    CreateSettingsUI --> SetupEventListeners[イベント・ボタンを設定]
    CreateSettingsUI --> AddAutoButtons[各アイテムに「自動」ボタン設置]

    %% 手動検索フロー
    SetupEventListeners --> SearchInput[キーワード入力]
    SearchInput --> ClickSearch[検索ボタンクリック/Enter]
    ClickSearch --> PerformSearch[NicoVideoSearcher.search]
    PerformSearch --> FetchSearchHTML[検索ページHTML取得 GM_xmlhttpRequest]
    FetchSearchHTML --> ParseServerContext[meta server-contextをDOMParserで解析]
    ParseServerContext --> ExtractItems[動画項目抽出]
    ExtractItems --> DisplayResults[検索結果を設定UIに表示]
    DisplayResults --> SelectResult[結果アイテムを選択]
    SelectResult --> FetchApiForSelected[NicoApiFetcher.fetchApiData by videoId]
    FetchApiForSelected --> SetCurrentVideo[setCurrentVideoで反映]
    SetCurrentVideo --> SaveVideoData[SettingsManager.saveVideoData メタ含む]
    SetCurrentVideo --> EnablePlay[現在の設定の再生ボタンを有効化]
    EnablePlay --> PlayButton[再生ボタンクリック]
    PlayButton --> TriggerPlay[dアニメ該当アイテムのリンクをクリック]

    %% 自動ボタンフロー
    AddAutoButtons --> AutoButtonClick[「自動」ボタンクリック]
    AutoButtonClick --> BuildQuery[題名+話数+話タイトルで検索語生成]
    BuildQuery --> PerformSearch
    PerformSearch --> ChooseBest[最適候補選択 再生数・類似度]
    ChooseBest --> TryApiOwner[APIで投稿者等を補完]
    TryApiOwner --> SetCurrentVideo
